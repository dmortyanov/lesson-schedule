{% extends "base.html" %}
{% block content %}
  <p class="muted">Ниже — минимальный интерфейс для демонстрации API без установки Postman.</p>

  <div class="grid">
    <div class="card">
      <h3>1) Получить JWT токен</h3>
      <label>Логин</label>
      <input id="auth-username" placeholder="username" value="">
      <label>Пароль</label>
      <input id="auth-password" placeholder="password" type="password" value="">
      <div style="margin-top:10px">
        <button onclick="getToken()">Получить токен</button>
      </div>
      <p class="muted">Создайте пользователя командой <code>python manage.py createsuperuser</code> или войдите под существующей ролью.</p>
    </div>

    <div class="card">
      <h3>2) Расписание по группе</h3>
      <label>ID группы</label>
      <input id="group-id" placeholder="например, 1">
      <div style="margin-top:10px">
        <button onclick="byGroup()">Показать</button>
      </div>
    </div>

    <div class="card">
      <h3>3) Расписание по преподавателю</h3>
      <label>ID преподавателя</label>
      <input id="teacher-id" placeholder="например, 1">
      <div style="margin-top:10px">
        <button onclick="byTeacher()">Показать</button>
      </div>
    </div>

    <div class="card">
      <h3>4) Свободные аудитории</h3>
      <label>Начало (ISO)</label>
      <input id="free-start" placeholder="2025-11-10T10:00:00">
      <label>Окончание (ISO)</label>
      <input id="free-end" placeholder="2025-11-10T11:30:00">
      <label>Тип (lecture/lab)</label>
      <input id="free-type" placeholder="lecture">
      <label>Вместимость ≥</label>
      <input id="free-capacity" placeholder="30">
      <div style="margin-top:10px">
        <button onclick="freeRooms()">Найти</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>Результат</h3>
    <pre id="out">Здесь появится ответ API</pre>
  </div>

  <script>
    let accessToken = null;
    const out = (data) => {
      const el = document.getElementById('out');
      el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    };
    const api = async (url, options={}) => {
      const headers = options.headers || {};
      headers['Content-Type'] = 'application/json';
      if (accessToken) headers['Authorization'] = 'Bearer ' + accessToken;
      const res = await fetch(url, {...options, headers});
      const text = await res.text();
      try { return {status: res.status, data: JSON.parse(text)}; }
      catch { return {status: res.status, data: text}; }
    };
    async function getToken(){
      const username = document.getElementById('auth-username').value;
      const password = document.getElementById('auth-password').value;
      const r = await api('/api/auth/token/', { method:'POST', body: JSON.stringify({username, password}) });
      if (r.status === 200 && r.data.access) {
        accessToken = r.data.access;
        out({ok:true, message:'Токен получен', ...r.data});
      } else {
        out(r);
      }
    }
    async function byGroup(){
      const gid = document.getElementById('group-id').value;
      const q = new URLSearchParams({ group_id: gid || '' });
      const r = await api('/api/lessons/by_group/?' + q.toString());
      out(r);
    }
    async function byTeacher(){
      const tid = document.getElementById('teacher-id').value;
      const q = new URLSearchParams({ teacher_id: tid || '' });
      const r = await api('/api/lessons/by_teacher/?' + q.toString());
      out(r);
    }
    async function freeRooms(){
      const start = document.getElementById('free-start').value;
      const end = document.getElementById('free-end').value;
      const type = document.getElementById('free-type').value;
      const capacity = document.getElementById('free-capacity').value;
      const q = new URLSearchParams({ start, end });
      if (type) q.set('type', type);
      if (capacity) q.set('capacity', capacity);
      const r = await api('/api/rooms/free/?' + q.toString());
      out(r);
    }
  </script>
{% endblock %}

