# Изменения в бэкенде для фронтенда

## Резюме изменений

В бэкенд были внесены **минимальные изменения**, которые не нарушают существующий функционал. Все изменения являются **дополнительными** и не затрагивают существующие API endpoints.

## Детальный список изменений

### 1. `core/views.py`
**Добавлено:**
- Класс `CurrentUserView` (строки 126-165) - новый API endpoint для получения информации о текущем пользователе

**Не изменено:**
- Все существующие ViewSet'ы остались без изменений
- Вся существующая логика работает как прежде

### 2. `core/urls.py`
**Добавлено:**
- Импорт `CurrentUserView`
- Новый URL path: `path("auth/me/", CurrentUserView.as_view(), name="current_user")`

**Не изменено:**
- Все существующие маршруты остались без изменений
- Router для ViewSet'ов работает как прежде

### 3. `schedule/urls.py`
**Изменено:**
- Главная страница (`path("", ...)`) теперь показывает `login.html` вместо `index.html`
- Добавлен маршрут для дашборда: `path("dashboard/", ...)`
- Старая страница API demo доступна по адресу `/api-demo/`

**Не изменено:**
- Все API endpoints остались на своих местах
- Админка доступна как прежде

### 4. `schedule/settings.py`
**Добавлено:**
- `STATICFILES_DIRS = [BASE_DIR / "static"]` - для обслуживания статических файлов из папки `static/`

**Не изменено:**
- Все остальные настройки остались без изменений

## Как проверить, что бэкенд работает

### Шаг 1: Проверка запуска сервера

```bash
cd lesson-schedule-main
python manage.py runserver
```

Если сервер запустился успешно, вы увидите:
```
Starting development server at http://127.0.0.1:8000/
Quit the server with CTRL-BREAK.
```

### Шаг 2: Проверка базы данных

Убедитесь, что миграции применены:
```bash
python manage.py migrate
```

Если миграций нет, вы увидите:
```
No migrations to apply.
```

### Шаг 3: Проверка API endpoints

#### 3.1. Проверка получения токена (без авторизации)
```bash
curl -X POST http://localhost:8000/api/auth/token/ \
  -H "Content-Type: application/json" \
  -d '{"username": "your_username", "password": "your_password"}'
```

Ожидаемый ответ (при правильных данных):
```json
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..."
}
```

#### 3.2. Проверка нового endpoint `/api/auth/me/` (требует авторизации)
```bash
curl -X GET http://localhost:8000/api/auth/me/ \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

Ожидаемый ответ:
```json
{
  "id": 1,
  "username": "admin",
  "first_name": "",
  "last_name": "",
  "email": "",
  "groups": ["ADMIN_DB"],
  "role": "ADMIN_DB",
  "teacher_id": null,
  "student_id": null
}
```

#### 3.3. Проверка существующих endpoints
```bash
# Получить список кафедр (требует авторизации)
curl -X GET http://localhost:8000/api/departments/ \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# Получить список групп
curl -X GET http://localhost:8000/api/groups/ \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### Шаг 4: Проверка через браузер

1. Откройте `http://localhost:8000/admin/` - должна открыться админка Django
2. Откройте `http://localhost:8000/` - должна открыться страница входа
3. Откройте `http://localhost:8000/api-demo/` - должна открыться старая демо-страница API

### Шаг 5: Проверка статических файлов

Убедитесь, что статические файлы загружаются:
```bash
# В браузере откройте консоль разработчика (F12)
# Перейдите на http://localhost:8000/
# Проверьте, что нет ошибок 404 для CSS и JS файлов
```

## Что НЕ было изменено

✅ **Модели** (`core/models.py`) - без изменений
✅ **Сериализаторы** (`core/serializers.py`) - без изменений  
✅ **Права доступа** (`core/permissions.py`) - без изменений
✅ **Настройки базы данных** - без изменений
✅ **Все существующие API endpoints** - работают как прежде

## Обратная совместимость

Все изменения **полностью обратно совместимы**:
- Старые API endpoints работают как прежде
- Существующий код не требует изменений
- Старая демо-страница доступна по адресу `/api-demo/`

## Если что-то не работает

### Проблема: Сервер не запускается
**Решение:**
```bash
# Проверьте, что все зависимости установлены
pip install -r requirements.txt

# Проверьте настройки базы данных в .env файле
# Убедитесь, что PostgreSQL запущен
```

### Проблема: Ошибка 404 на статические файлы
**Решение:**
```bash
# Соберите статические файлы
python manage.py collectstatic --noinput

# Или запустите сервер в режиме разработки (DEBUG=True)
# Django автоматически обслуживает статические файлы
```

### Проблема: Ошибка при получении токена
**Решение:**
- Убедитесь, что пользователь существует
- Проверьте правильность логина и пароля
- Убедитесь, что `djangorestframework-simplejwt` установлен

### Проблема: Ошибка 401 (Unauthorized) на `/api/auth/me/`
**Решение:**
- Убедитесь, что передаете валидный access token
- Проверьте, что токен не истек (по умолчанию 60 минут)
- Используйте refresh token для получения нового access token

## Тестирование

Для проверки, что все работает:

1. **Создайте тестового пользователя:**
   ```bash
   python manage.py createsuperuser
   ```

2. **Назначьте роль (через Django admin):**
   - Откройте `/admin/`
   - Перейдите в "Groups"
   - Добавьте пользователя в группу `ADMIN_DB`, `TEACHER` или `STUDENT`

3. **Войдите через фронтенд:**
   - Откройте `http://localhost:8000/`
   - Введите логин и пароль
   - Должна открыться страница дашборда

## Заключение

Все изменения в бэкенде являются **минимальными и безопасными**. Они добавляют только новый endpoint для получения информации о пользователе, который необходим для работы фронтенда. Существующий функционал не затронут.

